## Pokémon Generation 9 Battle Turn Structure and Mechanics

In a Generation 9 (Scarlet/Violet) turn-based battle, each turn unfolds through a sequence of phases. Implementing this in a real-time engine (Firebase + Next.js) requires accurately reproducing the logic at each phase. Below is a detailed breakdown of the turn structure, including handling of move priority, switching, damage calculation, and various mechanics, followed by an optimized Codex prompt for implementation.

### 1. Start of Turn Phase

At the start of each turn, the battle engine should handle automatic effects and conditions before players’ chosen actions execute:

- Entry Hazards: If a Pokémon is entering the field (e.g. due to a switch or replacing a fainted ally), apply entry hazard effects immediately. For example, Stealth Rock inflicts rock-type damage on the incoming Pokémon (damage scales with its weakness/resistance to Rock) and Spikes (1–3 layers) remove a fixed percentage of HP (12.5%, 18.75%, or 25%) . Toxic Spikes will poison or badly poison the newcomer (one layer = regular poison, two layers = bad poison), and Sticky Web reduces the new Pokémon’s Speed by one stage. These hazard effects occur as soon as the Pokémon appears, before any moves are executed.
- Ability Triggers on Switch-in: Some abilities activate upon entry. For example, Intimidate lowers opponents’ Attack as soon as the Pokémon is sent out, and Drizzle/Drought summon rain or sunlight weather respectively when the Pokémon enters . These take effect at the start of turn if a Pokémon with such an ability has just switched in. Only one weather can be active at a time, and setting a new weather will override the old .
- Field Conditions Check: If a weather condition is active (Rain, Sun, Sandstorm, Hail/Snow, etc.), it continues. Weather doesn’t typically produce an effect at turn start beyond a message, but its presence will matter for move execution and end-of-turn effects. For instance, Harsh Sunlight and Rain boost Fire and Water moves (50% increase) and weaken the opposite element . Sandstorm and Hail (replaced by Snow in Gen 9) do not deal damage at turn start, but will later at turn’s end if applicable . Terrain effects (Electric, Grassy, Misty, Psychic Terrain) if active will also persist, influencing moves and statuses (e.g. Electric Terrain boosts Electric moves and prevents sleep for grounded Pokémon for its duration). The engine should decrement turn counters for weather, terrain, or other timed field effects here or at end-of-turn as appropriate (typically these effects last 5 turns by default).
- Turn-Based Counters: Check any statuses or effects that might resolve at turn start. For example, the status Yawn (if a Pokémon became drowsy last turn) will make that Pokémon fall asleep now at the start of the turn (technically, Yawn causes sleep at the end of the next turn). In Gen 9, Tailwind and Trick Room typically expire at the end of their last turn (after that turn’s actions). Ensure that these ongoing effects have their remaining-turn counters updated.

Note: In official games, residual damage from status ailments (poison, burn) and weather is applied at the end of turn, not the beginning . The start-of-turn phase in an implementation context is primarily for handling new entrants and upkeep of field conditions. Any start-of-turn abilities (e.g. Speed Boost increases Speed at turn end, not start) will generally be handled in the end phase. Keep the sequence true to the games: status damage and healing occur after move execution, in the end-of-turn phase.

### 2. Move Selection Phase

During this phase, each player chooses an action for their active Pokémon. Both players’ choices are made simultaneously, and the turn will proceed once both have locked in their decisions:

- Action Choices: A player can choose to use a move, switch to a different Pokémon, or use an item (item usage is typically disallowed in competitive/link battles, but in a PvE context it would consume the turn). In Gen 9 multiplayer battles, usually only moves or switching are available options. If a Pokémon has no valid moves (e.g. out of PP on all moves), it is forced to use Struggle .
- Move Targeting: Along with move selection, the target (if applicable) is chosen. In single battles the target is usually the opposing Pokémon. Target choice matters for multi-target moves or double battles (not the focus here, but the engine should be designed to handle those cases as well).
- Switching: If a player selects “Pokémon” to switch their active creature with a bench Pokémon, that switch-out will occur instead of a move. The Pokémon coming in will be subject to entry hazards and switch-in ability effects as noted above. The withdrawn Pokémon will not act further this turn. Switching is a high-priority action (higher than nearly any move). In fact, when both players have chosen actions, all switch actions are resolved before moves are executed . (The only exception is the move Pursuit, detailed below.) If both players switch out on the same turn, the order of those switches is determined by the Speed of the Pokémon switching out – the faster Pokémon retreats first in official mechanics . This can be important because the Pokémon that switches out first also sends in its replacement first, which might affect abilities like Intimidate or weather-setting (the second Pokémon to switch in will experience the field after the first’s ability). However, since switching doesn’t directly interfere with the opponent’s action (barring Pursuit), the order of two switches generally doesn’t cause conflicts beyond ability interactions.
- Pursuit Exception: The Dark-type move Pursuit has a unique property – if a target is switching out, Pursuit will hit that target immediately before the switch occurs (and it doubles in power in that case) . In implementation, this means when determining turn order, check for any Pokémon using Pursuit against a target that decided to switch. A Pursuit in that scenario gains the highest priority (it will execute even before the switch completes). If Pursuit’s attack KOs the target before it can switch, the switch is canceled. Ensure the battle logic accounts for this edge case during the move resolution phase.
- Decision Lock-In: Once all players have submitted their choices, the turn proceeds to execution. In a real-time system, you might have both clients send their decisions to the server, and the server waits until it has both before continuing. The simultaneous selection means neither player’s choice is supposed to be informed by the other’s in the same turn.

### 3. Turn Execution Phase (Action Order Resolution)

With actions chosen, the battle engine now determines the order in which those actions occur and executes them one by one. Gen 9 uses a priority system and speed stats to decide this order:

- Switches and Items First: As mentioned, all non-move actions like switching (and item use, if allowed) happen before any move is attempted . If one player switches and the other uses a move, the switch-out (and new Pokémon entry) is performed first. The incoming Pokémon will face the opponent’s move when it fires off. If both sides switch, resolve both switch-outs (faster Pokémon’s switch first) before moving to any moves . Using an item (in single-player scenarios) similarly has top priority – the item’s effect is applied immediately, and that Pokémon forfeits its move that turn .
- Move Priority Brackets: Every Pokémon move has a hidden priority value (most moves are priority 0 by default). Some moves are higher priority (positive value) or lower (negative value). For example, Protect/Detect have +4 priority, Quick Attack and Aqua Jet have +1, whereas moves like Roar or Trick Room have -6 priority. The engine should sort all move actions by their priority value first . Higher priority moves take precedence – e.g. a Pokémon using a +1 priority move will act before a faster Pokémon using a +0 move . If a Pokémon is switching, it has already gone by now, so only remaining moves are considered in this ordering.
- Adjustments to Priority: Certain abilities and effects can modify move priority:
- Prankster ability gives all status moves +1 priority for that Pokémon (but note, Gen 7+ makes Dark-type targets immune to these elevated Prankster moves) .
- Gale Wings (Gen 9 version) gives +1 priority to Flying-type moves, but only when the user’s HP is full .
- Triage gives +3 priority to healing moves .
- These effectively change the priority bracket of the move and should be accounted for before sorting actions. The net result is that, for example, a Prankster Pokémon using a status move will act before any normal +0 moves.
- Also note field effects: Psychic Terrain prevents priority moves (priority > 0) from hitting grounded targets. If Psychic Terrain is up, a move like Quick Attack or a Prankster-boosted move targeting an enemy on the ground will effectively fail (or rather, it will be executed but have no effect). The engine should check this before execution – if a priority move is blocked by Psychic Terrain, it still “uses” up the action but doesn’t affect the target.
- Determining Order within Same Priority: If multiple actions share the same priority value (which is common, e.g. most moves are 0), then order is decided by each Pokémon’s effective Speed:
- The Pokémon with higher Speed stat will act first if in the same priority bracket .
- Speed Modifiers: Use each Pokémon’s current Speed after all modifiers. This includes stat stage changes (e.g. a Dragon Dance boost or Tailwind doubling Speed), item effects like Choice Scarf (+50% Speed), Iron Ball (halves Speed), ability effects like Chlorophyll (doubles Speed in sun), and status effects like paralysis. In Gen 9, paralysis reduces Speed to 50% (halved) , which can drastically change turn order. Make sure to apply all these multipliers to get the final Speed values for comparison.
- If a Pokémon’s ability Quick Draw (exclusive to Galarian Slowbro) activates (30% chance), or it holds a Quick Claw item (20% chance each turn), it gains priority within its bracket. In practice, if Quick Claw/Draw triggers, that Pokémon’s move will act before all other moves of the same priority bracket . If multiple Quick Claw/Draw users activate in one turn, their relative order still follows their Speed stats . (Custap Berry, if used, similarly gives a one-time +1 priority when at low HP, effectively ensuring the holder moves first in its bracket.)
- Conversely, items like Lagging Tail or Full Incense force a Pokémon to act last among moves of equal priority . The ability Stall (Sableye’s hidden ability) also makes the Pokémon act last in its priority bracket . These effects essentially treat the affected Pokémon’s action as if it has the lowest effective Speed in that bracket.
- Trick Room: If the field condition Trick Room is active, the turn order for moves of the same priority is reversed – the Pokémon with the lowest Speed goes first, and the fastest goes last . Implementing Trick Room means after applying all other factors, if Trick Room is up, invert the speed comparison. (Note: Trick Room does not affect priority brackets themselves; it only flips the within-bracket order.) If two Pokémon have identical Speed under Trick Room, it’s still a random tie-break as usual.
- Speed Ties: If after all calculations two Pokémon are exactly equal in Speed and in the same priority, the game breaks the tie randomly . Your implementation can choose a random outcome in such cases to decide who goes first (this should be done server-side for fairness).
- Action Execution: Execute actions one by one in the determined order:
- When a Pokémon’s turn to act comes, check if it is still able to execute its action:
- If it fainted earlier in the turn (from a higher-priority attack), its action is skipped (fainted Pokémon can’t act).
- If it was flinched (e.g. by an opponent’s prior move like Fake Out or a King’s Rock effect), it also skips its move due to flinch. (Flinching is usually caused by a move that has already hit this turn, preventing the flinched Pokémon’s action.)
- If it’s fully paralyzed this turn (25% chance each turn when paralyzed), the action is skipped as well .
- If the Pokémon is asleep or frozen, it cannot use a move (sleep lasts 1-3 turns typically, and freeze has a chance to thaw each turn). If it doesn’t wake or thaw this turn, its move fails. If it wakes up at the start of this turn, it can act normally. (In Gen 9, sleep duration counter decrements at the end of each turn; ensure the logic handles sleep correctly, possibly checking at action time if the Pokémon is still asleep).
- If the Pokémon was confused, you would check for confusion at action time: confusion gives a 33% chance to hit itself instead of the chosen move. (Confusion is a volatile status lasting 2-5 turns; hitting oneself in confusion is calculated similarly to a 40-base-power typeless physical hit on itself.)
- Also check Disable, Taunt, Encore, etc., that might prevent the use of the intended move. For example, if the chosen move is currently disabled or the Pokémon is Taunted and the move is status-category, the move will fail and be skipped .
- If none of these incapacitating conditions apply, the Pokémon will use its selected move. The engine then carries out the move’s effects (usually damage and/or status or stat changes).
- Move Resolution & Effects: When executing a move:
- Accuracy Check: First, if the move is an attacking move (not status), perform an accuracy check unless it’s guaranteed hit. Calculate the move’s effective accuracy = move base accuracy _ (user’s accuracy stat / target’s evasion stat). Apply modifiers like accuracy boosts/drops (stat stages) on the user and evasion boosts/drops on the target, as well as field modifiers (e.g. Fog if it existed, or abilities like Compound Eyes (+30% accuracy) or Sand Veil (20% evasion in sandstorm)). In Gen 9, new moves like Population Bomb have special accuracy rules (multiple hits with separate accuracy checks, etc.), but normally if the accuracy roll fails, the move misses and no damage/effect is dealt. Certain conditions ensure hits: moves like Swift never miss, and moves used by a Pokémon with No Guard or against a Pokémon with No Guard never miss; also if a move is in effect like Lock-On or an ability like Hone Claws boost accuracy, account for that.
- Critical Hits: Before damage is calculated, determine if the hit is a critical. Each move has a crit chance (base ~4.17%, which can be raised by high crit ratio moves or items like Scope Lens). If a critical hit occurs, damage will ignore negative stat stages on the attacker and positive stat stages on the defender for the relevant stats . For example, a critical hit physical move ignores the target’s Defense boosts and the attacker’s Attack drops. Critical hits in Gen 9 deal 1.5× the normal damage . (Some abilities and items modify this: Sniper ability boosts crit damage to 2.25× , and Battle Armor/Shell Armor on the target prevent being hit critically.)
- Damage Calculation: If the move deals damage, calculate it using Pokémon’s stats and a formula. The core damage formula in Pokémon includes the following factors :
- Base Power: Each move has a base power (which can be modified by effects like Technician ability boosting moves ≤60 power by 1.5×, or if the move is a critical hit of certain types, etc.). Some moves have variable power (e.g. Flail, Gyro Ball) or get boosted under certain conditions (e.g. Acrobatics doubles power if the user has no item).
- Attack & Defense Stats: Use the attacker’s relevant attacking stat (Attack for physical moves, Special Attack for special moves) and the target’s corresponding defense (Defense or Special Defense). These stats include any stat stage modifications (which are multiplicative factors per stage) and any abilities or items affecting them (e.g. Huge Power doubles Attack, Fur Coat halves physical damage by effectively doubling Defense). If a critical hit, as noted, ignore attacker’s negative or target’s positive stage mods in this calculation .
- Level: The attacker’s level factors into the damage formula (higher level = more damage).
- STAB: If the move’s type matches one of the attacker’s own types, a Same Type Attack Bonus applies. STAB is generally a 1.5× multiplier . In Gen 9, Terastallization can change a Pokémon’s type and also give STAB on the Tera type; if a Pokémon is Terastallized into a type it already had, the STAB can stack (effectively boosting to 2× for that type). Also, the Adaptability ability raises STAB from 1.5× to 2× for that Pokémon.
- Type Effectiveness: Determine the effectiveness of the move’s type against the target’s type(s). Use the type chart to get a multiplier: super-effective each adds ×2, not-very-effective each adds ×0.5, immunity is ×0 (no effect) . Multiply these together (e.g. a Fire move on a Steel/Grass Pokémon is 2×2 = 4× damage, a Normal move on Ghost is 0× so deals no damage). The engine should output messages or flags for “It’s super effective!” or “It’s not very effective…” etc., if needed, but logic-wise just apply the multiplier. If an immunity applies, set damage to 0 and skip the rest of damage steps.
- Weather Effects: Apply weather-based multipliers. In Rain, Water-type moves deal 1.5× damage and Fire-type moves deal 0.5× damage . In Harsh Sunlight, Fire moves are 1.5× and Water moves 0.5× . Other weather: Sandstorm and Snow don’t boost attack power (Sandstorm boosts Rock-types’ Sp. Def by 1.5×, which is indirectly accounted via stats, and Snow boosts Ice-types’ Defense by 1.5× ). Weather effects should be included in the calculation. (No weather in Gen 9 boosts accuracy except Sun enabling 100% Thunder’s chance to miss etc., but those are secondary effects.)
- Damage Modifiers (Abilities/Items): A variety of abilities and items can further modify damage:
- Burn: If the attacker is burned and using a physical move, its damage is halved (0.5×) , unless the attacker has the Guts ability (which ignores the attack drop and even boosts Attack by 50% when statused) or if the move is Facade (which explicitly doubles in power when user is burned/paralyzed/poisoned from Gen VI onward, negating the burn penalty) .
- Reflect/Light Screen/Aurora Veil: If the target’s side has Reflect (physical moves) or Light Screen (special moves) up, and it’s a single battle, damage from the respective category is halved (0.5×) . In a double battle, these shields reduce damage to 2/3 (approximately 0.67×) if more than one target is hit . The screens do not apply if the attack was a critical hit (crit bypasses the damage halving) or if the attacker has Infiltrator ability (which ignores screens). Aurora Veil (if active under Hail/Snow) similarly halves damage from both physical and special moves. Implement a check for these field conditions on the target’s side when calculating damage.
- Multi-target penalty: In double battles, if a move hits multiple Pokémon (like Earthquake or Surf hitting both foes), its damage is 0.75× (3/4) normal . (Not relevant in singles, but worth noting for completeness in engine design.)
- Ability Modifiers: e.g. Technician boosts moves with base power ≤60 by 1.5×, Fluffy ability halves damage from contact moves (and doubles damage from Fire moves) , Solid Rock/Filter/Prism Armor reduce incoming super-effective damage to 0.75×, Tinted Lens doubles damage of not-very-effective hits, Water Bubble halves damage from Fire moves against the Pokémon, etc. The engine should be extensible to account for these ability-specific modifiers in the damage step if the combatants have them.
- Item Modifiers: e.g. Life Orb boosts all damage by ~1.3× (5324/4096 to be exact) , Choice Band/Specs boost Attack or Sp. Atk by 1.5× respectively (which effectively increases damage by 1.5× on that stat’s moves), Expert Belt boosts super-effective move damage by 1.2× , type-boosting held items (like Mystic Water for Water moves) give 1.2×, Metronome item boosts repeated use of the same move (increasing 20% each consecutive hit, up to 100% extra), Type-resist Berries halve damage of a specific super-effective hit once , etc. These are applied at the end as multipliers in the damage formula. If multiple apply, they stack multiplicatively .
- Random variance: The formula includes a random factor between 0.85 and 1.00 (i.e., a uniformly random integer between 85% and 100% of the rolled damage). This produces slight randomness in damage. Implement this as a random roll for each damage instance.
- After applying all modifiers, the formula yields the damage to subtract from the target’s HP. Damage is at least 1 (except in cases where it’s 0 due to immunity). Apply the HP reduction to the target Pokémon. If damage >= current HP, the target’s HP drops to 0 and it faints. Mark the target as fainted, but (in Gen 4+ mechanics) do not remove it from the field until the turn is fully over . The fainted Pokémon cannot take any further action this turn (if it hadn’t moved yet, its action will be skipped).
- Move Effects: After dealing damage, apply any additional effects of the move:
- Secondary effects: Many moves have a chance to inflict a status or stat change on the target. For example, Thunderbolt has a 10% chance to paralyze, Flamethrower 10% to burn, Psychic 10% to lower Sp. Def, etc. If the move hit, roll for these chances and apply accordingly (unless the target is immune to that status or has abilities like Shield Dust that block secondary effects). The engine should queue these effects after damage calculation.
- Multiple hits: If the move is a multi-hit move (like Double Kick, Icicle Spear, Bullet Seed, etc.), handle it as follows:
- Determine how many hits will occur. Moves that hit 2-5 times use a distribution (in Gen 9, 35% each for 2 or 3 hits, 15% each for 4 or 5 hits by default , unless the user has Skill Link which forces the maximum hits). Some multi-hit moves have fixed hits (Triple Kick = 3 hits, Dual Chop = 2 hits, etc., or Population Bomb which can hit up to 10 times). Loaded Dice item skews the random hits towards the upper range (for 2-5 hit moves it makes 4-5 hits more likely) .
- Each hit is processed sequentially. Perform accuracy and damage calculation for each hit. Note that starting Gen 5, each hit can crit independently and has its own accuracy check (except some moves like Triple Axel from Gen 9 have one accuracy check for all hits ). The damage from each hit is usually calculated with the same formula and modifiers. However, stat changes or type changes that occur mid-move can affect later hits (e.g. Color Change ability might change target’s type after the first hit ).
- The move continues hitting the target until the specified number of hits is reached or the target faints. If the target faints mid-move (say after the 3rd hit of a 5-hit move), the remaining hits are skipped because the target is no longer present.
- Each hit can trigger abilities or item effects that respond to being hit. For example, Rough Skin or Rocky Helmet will inflict recoil damage to the attacker for each hit of a multi-hit move that made contact . Abilities like Weak Armor (lower Defense, raise Speed when hit by a physical move) will trigger on a hit and can affect the subsequent hits (Weak Armor triggers after the hit, so remaining hits will see the new Defense stat). Focus Sash or Focus Band: if a Pokémon is at full HP and takes a multi-hit attack, Focus Sash will prevent fainting from the entire move only if the first hit would have KO’d it. In practice, if a multi-hit move would KO a full-HP Pokémon, Focus Sash leaves it at 1 HP after that hit, but subsequent hits will then KO it anyway (Focus Sash only works once and is consumed) – effectively multi-hit moves can break Sturdy/Focus Sash because the later hits still land after the survival. The engine should implement Sash/Sturdy such that they only prevent death at the final hit of a multi-hit sequence if the sequence started at full HP and would KO; in other words, the Sash lets it survive the first hit with 1 HP, but the next hit will KO it. (By contrast, Focus Band has a 10% chance on any would-be KO to survive at 1 HP – in Gen 2, if Focus Band saved a Pokémon on an earlier hit of a multi-hit move, subsequent hits that turn would not KO it , but modern mechanics treat each hit separately for Focus Band’s chance.)
- Show a message after the move like “Hit X times!” if needed. The main logic is to loop through the number of hits and treat each as an individual damage instance with all the side-effects each time.
- Recoil moves: If the move causes recoil (e.g. Brave Bird, Flare Blitz, Take Down), after dealing damage, the attacker loses some HP. Usually recoil is a fraction of the damage dealt: e.g. 1/3 of damage dealt for most recoil moves, 50% for Head Smash, or 1/2 for Struggle. Implement by calculating recoil = (damage dealt _ fraction), rounding down, and subtracting from the user’s HP. Recoil cannot KO the user in main games except Struggle and Shadow Rush recoil can. (In Gen 9, if a recoil would drop the user to 0, the user faints – older gens had a quirk where recoil would not KO you if the target fainted from the hit, but that no longer applies.)
- Drain moves: Moves like Giga Drain, Drain Punch, etc. heal the user for a portion of damage dealt (typically 50%). After damage, heal the user by that amount (capped by its max HP). If Big Root item is held, increase the healing by 1.3×.
- Self-stat drops: Some moves have recoil in the form of stat drops or other costs (e.g. Close Combat lowers user’s Def/SpDef by 1, Draco Meteor lowers user’s SpA by 2 after use). Apply these stat stage changes to the user after the move lands.
- Secondary Target Effects: If the move hits multiple targets (again more relevant in double battles), apply damage and effect to each target. Some moves have different effects on different targets (e.g. Parabolic Charge heals based on total damage).
- Fainted Targets: If the target fainted, mark it. In Gen 9, the fainted Pokémon will be removed only after the entire turn’s actions are done. However, no further moves can target it this turn (if an opponent later in the order was planning to target that Pokémon, their move will fail due to no target).
- Move Conclusion: Once the move’s damage and effects (and any immediate recoil/drain) are resolved, proceed to the next action in the sequence.
- Example (Putting it Together): Suppose Pokémon A (faster) uses Thunderbolt on Pokémon B, and Pokémon B chose Surf. Turn order: If no priority moves, A goes first by Speed. A’s Thunderbolt hits, passes accuracy, perhaps scores a crit. It deals damage (apply STAB if A is Electric, type effectiveness against B’s type, etc.). Say Thunderbolt deals enough to KO Pokémon B. Pokémon B is marked fainted and won’t get to use Surf. Pokémon B’s action is skipped. If Thunderbolt didn’t KO B but paralyzed it, B’s Speed is now quartered (halved in Gen 9 actually) – however, since B was supposed to act after A anyway, the paralysis status can also introduce a chance B can’t move. If B then tries to Surf and gets fully paralyzed, it fails. If not paralyzed, Surf executes and hits Pokémon A for damage. After all actions, end-of-turn effects occur (see below), and if B fainted, it will be replaced at end of turn.

### 4. Damage Calculation Specifics (Type, STAB, Critical, Weather, etc.)

This section summarizes the key components of damage computation for clarity, to ensure the engine replicates the exact Gen 9 logic:

- Formula: The classic damage formula (simplified) is:
\text{Damage} = \left(\frac{2 \times \text{Level}}{5} + 2\right) \times \text{Power} \times \frac{\text{Attack Stat}}{\text{Defense Stat}} \div 50 + 2,
then multiplied by all the modifiers described (and then floored to an integer) . The “Attack Stat” and “Defense Stat” above already include stat stage multipliers and any ability/item boosts. The engine doesn’t need to output this formula but should implement each part of it:
- Stat stages: use stage multipliers (e.g. at +2 stage, stat is ×2.0; at -1 stage, stat is ×0.667).
- Don’t forget the +2 flat after the division in formula (this is minor but ensures at least minimal damage).
- Then apply modifiers: critical (1.5×), random factor (0.85–1.0×), STAB (1.5×), type effectiveness (0, 0.25, 0.5, 1, 2, or 4×), weather (1.5× or 0.5× for certain types), etc., as detailed earlier.
- All modifiers multiply together. Typically, after each multiplication, the game truncates (floors) the result. The final damage is at minimum 1 if any damage is dealt at all.
- Same-Type Attack Bonus (STAB): 1.5× if the user’s type matches the move . Adaptability ability makes this 2×. If Terastallized, a Pokémon gets STAB on its Tera type (even if it didn’t before) and if it has the same type as move via both original and Tera type, the game effectively gives a 2× bonus (stacked STAB).
- Type Effectiveness: Use the target’s combination of types to determine effectiveness . Multiply the damage by 2 for each super-effective, by 0.5 for each resistance, by 0 for immunity. For dual-types: e.g. a Fighting move on a Normal/Dark Pokémon is 4× (2×2), a Ground move on Flying/Electric is 0× (immune via Flying), etc. Gen 9 has no new type chart changes beyond the standard.
- Critical Hits: 1.5× damage multiplier (since Gen 6) . Also ignore certain stat stage buffs as noted. High crit ratio moves (like Night Slash, Stone Edge) have higher chance to crit (roughly 12.5% or more depending on stacking effects). Laser Focus move can guarantee the next hit is a crit. Implement by flagging critical and adjusting damage and stat stage usage accordingly.
- Weather: If Rain is active, multiply Water move damage by 1.5 and Fire move damage by 0.5 . If Sun is active, Fire moves 1.5×, Water moves 0.5× . Sandstorm and Snow do not change damage of moves (Sandstorm’s Sp. Def boost for Rock types is effectively a stat change, not a direct multiplier on damage). Harsh sunlight (extreme sun from Groudon’s Primal form) and Heavy rain (Primal Kyogre) actually make Water or Fire moves completely unusable respectively, but those we might not need to handle unless including those abilities (Desolate Land, Primordial Sea). Weather Ball move doubles power and changes type with weather. The engine should handle moves changing type or power when weather/terrain are present (e.g. Weather Ball, Terrain Pulse).
- Terrain: Not explicitly mentioned in the question, but for completeness: Electric Terrain boosts Electric moves by 30% for grounded Pokémon, Grassy Terrain boosts Grass moves by 30% for grounded, etc., and also applies healing or status prevention. Include these in damage calc if terrain is active and the move matches the terrain type and the target or user is grounded (not flying/levitate). Psychic Terrain boosts Psychic moves by 30% as well.
- Status Conditions Impact: Burn halves physical damage (accounted above) . Being poisoned or paralyzed doesn’t directly change damage (paralysis only affects Speed and the chance to act). Frostbite is a special status from Legends: Arceus (not present in main Gen 9) analogous to burn but for special attacks – not relevant in S/V. Freeze and sleep just prevent action.
- Calculating One-Hit KO: If a move is of category OHKO (like Sheer Cold), you typically check accuracy separately (30% base, modified by level difference in older gens). If it “hits,” it sets HP to 0 outright. Implementing OHKO moves can be a simple conditional: if move is OHKO and it hits, target faints (if target level <= user level, because OHKO moves fail on higher-level targets).
- Fractional Damage Moves: Moves like Night Shade or Seismic Toss do fixed damage equal to user’s level. Dragon Rage always 40 HP. These bypass the normal formula. Implement them explicitly by their effects.
- Damage Messaging: The engine might not handle UI, but logically it should determine when to display messages like “It’s not very effective…” (when the multiplier < 1), “It’s super effective!” (multiplier > 1), “It doesn’t affect [Pokemon]…” (damage = 0). This can be derived from type effectiveness results.

### 5. Aftermath Effects (Post-Move, mid-turn)

After each action’s execution, there may be additional effects that occur immediately as a result of that action. These are distinct from end-of-turn effects, as they happen right after the move is done but before the next action in the sequence:

- Recoil Damage: As noted, moves with recoil will damage the user after dealing damage to the target. The user could potentially faint from recoil at this point. If recoil KO’s the user, the user is marked fainted (and won’t perform any further actions if it somehow had another, e.g. in multi-turn sequences or Dancer ability scenarios).
- Life Orb Recoil: If the attacker was holding a Life Orb, after any damaging move it uses (even if the move misses? In official games, Life Orb recoil only applies if the move hit the target), it loses 10% of its max HP . This recoil occurs after each hit for multi-hit moves as well (Life Orb will only deduct HP once per move used, not per hit). If the Life Orb recoil causes the user to faint, it faints now (this can happen if the user was at exactly 1 HP before attacking, for instance).
- Ability – Rough Skin/Iron Barbs/Rocky Helmet: If a Pokémon was hit by a contact move and has Rough Skin or Iron Barbs, the attacker takes 1/8 of its max HP in damage immediately . If the attacker was holding Rocky Helmet, a contact move by the opponent causes the attacker (the one who made contact) to take 1/6 of its max HP in damage. These effects occur per hit for multi-hit moves, potentially resulting in significant self-damage. The engine should deduct HP from the attacker for each such effect. If this damage causes a Pokémon to faint, that faint happens right away.
- Leech Seed: If a Pokémon was seeded by Leech Seed and it took damage from a move or anything, Leech Seed’s effect won’t apply until end of turn. (Leech Seed is an end-turn effect; see below.)
- Status Afflictions from Abilities: Many defender abilities may trigger when hit:
- Static (30% chance to paralyze the attacker on contact), Flame Body (30% chance to burn on contact), Poison Point (30% chance to poison on contact). If the move made contact, check these abilities and if triggered, apply the status condition to the attacker after the move’s resolution . Only one of these can trigger per move; if a Pokémon has one, just roll once. These effects also can trigger on each hit of a multi-hit move (each hit gives a chance).
- Effect Spore (30% chance to inflict paralysis, poison, or sleep randomly on contact) works similarly.
- Weak Armor (when hit by a physical move, lowers Def by 1 and raises Speed by 2 on the target) triggers now, possibly altering the target’s stats for any later moves this turn.
- Justified, Competitive, etc.: Some abilities activate when a Pokémon is hit by moves of certain types or stats are lowered. Ex: Justified boosts Attack when hit by a Dark move. If such conditions occurred, apply the stat boost now.
- Emergency Exit / Wimp Out: If a Pokémon’s HP fell below half due to the move, these abilities will force it to switch out immediately (if it hasn’t already acted). In a singles battle, that means the Pokémon will immediately flee and its trainer must send a replacement mid-turn. This can complicate turn order: e.g. if a Pokémon with Emergency Exit is faster and was about to use a move later, but an earlier hit dropped it below half, it will switch out right then. For simplicity, treat this similar to a forced switch event triggered in the middle of turn. The replacement Pokémon coming in will not act this turn (since the switch consumes its turn), but it will come in and potentially face any remaining attacks. This is an advanced scenario to implement: it requires inserting a switch mid-turn and possibly adjusting the action queue if the Pokémon that got switched out had not moved yet (its pending action is canceled).
- Faint-induced Abilities: If a Pokémon fainted due to the move, some abilities trigger on faint. For example, Moxie gives the attacker +1 Attack stage if it KO’d a target. Apply that stat boost now. Perish Body (curses both Pokémon with perish count if contact was made and one faints) or Soul Heart (Magearna’s ability to raise Sp. Atk when anyone faints) are others to consider. These effects should be processed after the move that caused the faint.
- Item Triggers: After taking damage or under certain conditions, items may be consumed or activated:
- Berries: Many berries trigger when HP drops below a threshold (e.g. Sitrus Berry at 50% HP heals 25% max HP, Figy/Wiki berries at 25% HP heal 33% but cause confusion for certain natures). If a Pokémon’s HP fell into the trigger range as a result of damage, immediately have it eat the berry and restore HP (or apply the effect). This can potentially prevent a faint if a Pokémon was brought to 0 HP exactly – but note, in official games, if damage brings a Pokémon to 0, it faints before using a berry. Berries activate only if the Pokémon is still alive after the hit, at the moment the condition is met. So implement: after applying damage, if HP > 0 and at or below the berry’s threshold, consume the berry and adjust HP (capping at max HP). This could happen mid-turn between actions.
- Focus Sash / Focus Band / Sturdy: These prevent certain KOs during move damage:
- Focus Sash (held item): If a Pokémon is at full HP and would be KO’d by a hit, Focus Sash leaves it at 1 HP instead and is consumed. This is handled during damage calculation – if damage >= current HP and current HP == max HP, set HP to 1 instead of 0 and flag the Sash as used. This happens per hit (so multi-hit moves as discussed).
- Sturdy (ability): In Gen 9, it similarly prevents a one-hit KO from full HP (just like a built-in Focus Sash). Implementation is the same check as Sash for ability: if at full HP and damage would KO, leave at 1 HP, and Sturdy becomes “used” (though it can trigger again if healed back to full in the same battle).
- Focus Band (held item): Has a 10% chance to survive a would-be KO at 1 HP. Unlike Sash, it works even if not at full HP. Implement by, when a Pokémon is about to faint from damage, if it holds Focus Band, roll RNG 10%; if successful, leave it at 1 HP instead of fainting (and the item is not consumed – it can activate multiple times).
- Eject Button / Eject Pack: If a Pokémon holding Eject Button is hit by an attack, after the attack, the item triggers and forces that Pokémon to switch out immediately (if it has allies to switch to). Eject Pack triggers when the holder’s stats are lowered. These cause immediate switching similar to Emergency Exit. Handle by marking that Pokémon to switch out after the move’s resolution, and prompt its trainer for a replacement (mid-turn switch).
- Red Card: If the holder is hit by a move, it forces the attacker to switch out immediately after damage. This also requires triggering a mid-turn switch for the attacker. Only one Red Card activation can happen per turn because it’s consumed.
- White Herb / Power Herb, etc.: If a stat drop happened (White Herb restores stats once) or a charge move was used (Power Herb skips the second turn of moves like Solar Beam), those items would activate at their respective triggers. White Herb likely triggers after a move that causes the holder’s own stat to drop (e.g. Close Combat).
- Ability Shields / Protective Pads: These would prevent some of the above effects (like Protective Pads prevent contact abilities and Rocky Helmet recoil).
- Multi-turn moves: Some moves, like Sky Attack or Dig/Fly or Solar Beam, involve “charging” on the first turn and executing on the second. In implementation, when a Pokémon uses Dig or Fly, mark it as semi-invulnerable (cannot be hit by most moves) until its next action, and skip doing damage on that first turn. On the second turn, execute the move’s damage. If the Pokémon was hit by a move like Earthquake during Dig (Earthquake does double damage to a digging target) , handle that appropriately. Also, Bide lasts 2 turns then deals damage equal to double what it took; Focus Punch can fail if the user was hit earlier in the turn, etc. These cases are advanced but important for full accuracy. For example, implement Protect (see below) to also block damage from multi-turn moves if the user is underground or in the air that turn.
- Protect and Endure: Protect/Detect/Baneful Bunker/King’s Shield/Spiky Shield are moves a Pokémon can use to guard itself for the turn:
- Protect has +4 priority , so it often goes first. If used successfully, that Pokémon avoids all effects of moves targeting it for the rest of the turn . The engine should mark the Pokémon as “protected” for that turn after it uses Protect. When another Pokémon tries a move targeting a protected Pokémon, the move is blocked – no damage or secondary effects on that target occur. (Moves that hit multiple targets will simply do nothing to the protected mon but still affect others.)
- Some moves bypass Protect partially: Feint (and similar moves like Shadow Force) can hit through Protect, breaking it. Z-Moves (not in Gen 9) and Max Moves (not in Gen 9 either) do reduced damage through Protect. In Gen 9, Clones like Phantom Force bypass protect. Also, Unseen Fist ability (Urshifu) lets contact moves hit through Protect. The engine should check if the attacker’s move is one that breaks Protect or the attacker has an ability that negates it . If so, the move will hit despite Protect (possibly with reduced damage if specified).
- Consecutive uses of Protect have a diminishing success probability. The first use almost always works (100% unless under specific conditions). If the same Pokémon uses a protect move again next turn (or even the same turn via something like Instruct), the success rate falls to 50%, then 25%, etc. . The engine can track a counter for consecutive Protect uses for each Pokémon to apply this. (Note: All “protective” moves share this counter – e.g. using Protect then Detect next turn counts as consecutive use.)
- Endure is similar but instead of blocking moves, it ensures the Pokémon survives any hit that turn with at least 1 HP (like a temporary Sturdy). It also has reduced success on consecutive use. For implementation, if Endure was used successfully by a Pokémon this turn, any damage that would faint it should leave it at 1 HP instead (and Endure fails under the same consecutive-use penalty rules).
- Other Priority Interactions: Quick Guard (protects team from priority moves that turn), Wide Guard (protects team from multi-target moves that turn) are niche but worth noting for a full engine. They are +3 priority moves. If Quick Guard is up on a side, any +1 or higher priority move from the opponent targeting that side is blocked (fails). Wide Guard blocks moves like Earthquake, Surf, etc., for that turn. Consecutive use also lowers success chance.
- Forced Mid-Turn Switching Recap: If any ability or item forces a switch mid-turn (Emergency Exit, Eject Button, Red Card, etc.), handle it as soon as it triggers:
- The Pokémon to be switched out leaves the field, and a replacement from its team is sent in immediately (pause the turn order to get a choice from that player if interactive, or auto-send next in line for AI). The new Pokémon does not act this turn (since the original Pokémon already used its action). Resume the turn order with the next scheduled action. The new Pokémon will be subject to hazard damage and ability effects upon entry as usual. If the opponent had a remaining action targeting the slot of the Pokémon that switched out, that action will now target the new Pokémon.
- If multiple such effects trigger at once (rare, but e.g., a Pokemon with Emergency Exit hits another holding Red Card and both drop below half / get hit, etc.), process them one at a time in some consistent order (likely turn order or attacker/target order).
- Dancer Ability: If any Pokémon on the field has the ability Dancer (Oricorio’s ability) and any Pokémon uses a Dancing move (like Quiver Dance, Swords Dance, Fiery Dance, etc.), the Dancer will immediately after that move’s effect, use the same move. This happens mid-turn, potentially before the next normally scheduled action . Implement by checking after a move completes: if a move has the dance flag and a Pokémon with Dancer is on the field and hasn’t already danced this sequence, insert an action for each Dancer to use the same move right away. This effectively alters the order in real time.
- Instruct (move): If Oranguru uses Instruct on an ally, it causes that ally to immediately repeat its last used move this turn. This can also insert an extra action mid-turn after the target’s action.
- Round (move): If multiple Pokémon use Round in one turn, the one who moves first executes Round normally, and any other Pokémon who chose Round will move immediately after the first Round (regardless of their normal speed) in the same priority bracket . Essentially, they get bumped up to follow consecutively. This is a special case in double battles usually.

The above special cases (Dancer, Instruct, Round, etc.) are advanced and mostly relevant for multi-battle scenarios, but a comprehensive engine should handle them as they can occur even in singles (e.g., an ally with Dancer in a double battle, or an opponent using Instruct in a double battle). For a singles-only engine, you can skip Round and Instruct mechanics, but Dancer could still trigger off an opponent’s move theoretically.

### 6. End of Turn Phase

After all actions in the turn have been executed and resolved (including any switches or fainting that happened during the turn), the game processes end-of-turn effects. These are periodic effects that happen once per turn after everything else, and they can affect the outcome going into the next turn. In your engine, once the action queue for the turn is done, perform the following for each Pokémon (order of these effects is predefined in the games):

- Weather Damage or Healing: If a weather condition is active that causes damage, apply it now:
- Sandstorm: All Pokémon that are not Rock, Ground, or Steel type take damage equal to 1/16 of their max HP at end of turn . (Ability Overcoat or item Safety Goggles or the Magic Guard ability will prevent this damage .)
- Hail/Snow: In Gen 9, hail has been replaced by Snow, which no longer causes damage. (Previously Hail would damage all non-Ice types by 1/16 HP similarly .) Now, Snow instead boosts Ice-types’ Defense by 50% while active . So, for Gen 9 mechanics, no end-of-turn damage from snow. If you still include Hail as a legacy mechanic, handle it like sandstorm for non-Ice types.
- Sunlight or Rain: No damage at turn end, but they might affect other end-of-turn abilities (e.g. Solar Power ability – a Pokémon with Solar Power loses 1/8 HP each turn in sunlight).
- Weather-related end-of-turn abilities: Rain Dish heals 1/16 HP in rain, Dry Skin heals 1/8 HP in rain (and conversely Dry Skin users lose 1/8 HP in sun at end of turn, and Ice Body heals 1/16 in hail, etc.). Implement these by checking each Pokémon’s ability and weather combination.
- If weather (or terrain) duration expires this turn (e.g. 5th turn of Rain), end it now and possibly display a message (“The rain stopped”). The weather’s effects will no longer apply next turn. Typically, weather turns count down at the end of each turn.
- Status Condition Damage/Healing:
- Poison: A poisoned Pokémon takes damage at end of turn. Regular poison deals 1/8 of max HP . Badly poisoned (toxic) damage increments each turn: first 1/16 max HP, then 2/16, 3/16, etc., increasing by 1/16 each turn the Pokémon remains in battle with bad poison . The counter resets if the Pokémon is switched out. Implement a toxic counter that increases by 1 each time the Pokémon ends a turn poisoned; damage = (toxicCounter _1/16_ max HP). From Gen 5 onward, toxic damage no longer resets to regular poison if the Pokémon is out for long; it stays ramped as long as it remains poisoned and in battle.
- Burn: A burned Pokémon loses 1/16 of max HP each turn (Gen 7+ made burn damage 6.25% per turn, whereas it was 12.5% in Gen 6) . Burn damage occurs now, and cannot KO a Pokémon (in main games, if burn damage would drop a Pokémon to 0, it will faint – so actually it can KO). Check for Magic Guard ability (which prevents indirect damage like poison/burn).
- Paralysis: No damage at end turn; paralysis’ effect is the Speed drop and the earlier chance to be immobilized.
- Sleep/Freeze: No automatic damage. For sleep, decrement the sleep turn counter. If it reaches 0, the Pokémon wakes up now at end of turn (so it will be awake for the next turn). For freeze, each turn there’s a 20% chance to thaw at the end of turn; if so, the Pokémon is no longer frozen for next turn. (Certain moves/conditions can thaw immediately when executed, but that’s handled during move execution.)
- Bad Poison Increment: Increase the toxic counter for badly poisoned Pokémon after applying this turn’s damage, so that it does increased damage next turn.
- Frostbite (only in Legends Arceus, not applicable in S/V unless integrating PLA mechanics) would also do 1/16 each turn.
- Leech Seed: If a Pokémon is seeded, it loses 1/8 of its max HP at end of turn, and the seeding Pokémon (if still alive) gains the same amount of HP . If multiple Pokémon are seeded (happens in multi battles), each gets drained and healing goes to the seeder’s corresponding Pokémon. If the seeded Pokémon or the seeder fainted before end of turn, no effect (no drain or heal). Implement by subtracting HP and adding to the seeder (cap at seeder’s max HP). Also consider Big Root item on the seeder (Leech Seed healing is 1.3× if the recipient holds Big Root).
- If a seeded Pokémon faints from Leech Seed damage, that faint is handled like any faint (the Pokémon will be replaced afterwards).
- Binding/Partial-Trap Moves: If a Pokémon is under the effect of moves like Fire Spin, Whirlpool, Wrap, etc., these do residual damage at end of turn (typically 1/8 of max HP each turn) . They usually last 4-5 turns. If so, apply that damage and decrement the remaining turn counter for the binding effect. If the counter hits 0, the bind ends (the Pokémon is freed).
- Infestation is similar (residual damage each turn).
- These effects can KO a Pokémon as well. Check if the trapped Pokémon fainted.
- Curse (if afflicted by a Ghost’s Curse move): The cursed Pokémon loses 1/4 of its max HP at end of each turn. Apply that now if present.
- Nightmare: If a Pokémon is asleep under Nightmare status, it loses 1/4 HP each turn. Apply if relevant.
- Hellish Song (Perish Song): If Perish Song was used, each affected Pokémon has a perish count (starting at 3, then 2, 1, then 0). At end of turn, decrement the perish count. If any Pokémon’s perish count reaches 0 now, those Pokémon faint immediately . (Perish Song KO happens after all other end-turn effects in the actual games.) Implement checking perish counters after other damage – if 0, faint the Pokémon. Usually, both can faint simultaneously if not switched out.
- End-of-Turn Healing Items:
- Leftovers: Heals 1/16 of holder’s max HP at end of each turn . Apply after damage effects: add HP (not exceeding max). Black Sludge: If held by a Poison-type, works like Leftovers (heals 1/16). If held by a non-Poison-type, it damages the holder by 1/8 each turn. So check item: if Black Sludge and holder not Poison, subtract 1/8 HP.
- Shell Bell: Heals the user by 1/8 of damage it dealt during the turn, at the end of the turn. You would need to accumulate how much damage each Pokémon inflicted and to how many targets, sum it up, and then heal 1/8 of that for the Shell Bell holder. This happens at end of turn with a single heal.
- Terrain Seeds (Electric Seed, etc.): These activate when terrain starts, not an end-turn thing; no continuous effect.
- End-of-Turn Stat/Ability Effects:
- Speed Boost: If a Pokémon has the Speed Boost ability, its Speed stat rises by +1 stage at the end of each turn . Apply now (if the Pokémon isn’t fainted).
- Moody: A Pokémon with Moody ability will randomly raise one stat by +2 and lower another by -1 at end of turn. Implement by choosing a random stat to boost (Attack/Defense/SpA/SpD/Speed/Evasion/Accuracy) and a different random stat to drop.
- Regenerator doesn’t apply here; it heals when switching out, which is handled on switch.
- Grassy Terrain: At end of turn, if Grassy Terrain is active, all grounded Pokémon heal 1/16 of max HP.
- Hydration: Cures any status at end of turn if Rain is active (so if the Pokémon is paralyzed/poisoned etc. and it has Hydration, remove the status now) .
- Shed Skin: 30% chance to cure status at end of turn.
- Healer (doubles): 30% chance to heal an ally’s status at end of turn (for double battles).
- Status fade: Some temporary volatile statuses end after a certain number of turns, which might be tracked and resolved at end-turn:
- Taunt, Encore, Disable, Magnet Rise, Telekinesis, etc.: decrement their turn counters, end them if time is up (free the Pokémon from the condition).
- Reflect/Light Screen/Tailwind: usually last 5 turns; decrement and expire at end of turn if their duration ends (“Reflect wore off!”).
- Trick Room / Weather / Terrains: as mentioned, expire after their turn count at end-turn.
- Dynamax (not in Gen 9) would end after 3 turns at end-turn if it were present.
- Fainted Pokémon Replacement: This is crucial – after processing all end-of-turn effects, if any Pokémon fainted either during the action phase or just now at end of turn, prompt their trainers to send out a replacement from their party (in a multi Pokémon battle). According to Gen 9 rules (Gen 4 and onward), if a Pokémon fainted during the turn, the replacement is not sent out until the end of the turn . Now is that time:
- For each fainted Pokémon on the player’s side, if there are remaining Pokémon in the party, the game will request a switch-in. In a sequential battle system, this typically happens before the next turn begins (with the game waiting for the player to choose a Pokémon). In a simultaneous online system, you might also have to handle this asynchronously: e.g. pause the battle flow and ask the player to pick a new Pokémon. The battle does not progress until replacements are chosen.
- When the new Pokémon is sent out, immediately apply any switch-in effects for it: entry hazards (Spikes, Rocks, etc.) and abilities (Intimidate, etc.) as described in Start of Turn. However, note that this switch-in is happening outside the normal turn order, effectively in a between-turn state.
- If multiple Pokémon fainted on the same turn (especially possible in multi battles or due to recoil causing double KO), both sides choose new Pokémon now. If one side is out of Pokémon (no replacements), the battle ends (win/loss is decided).
- Once replacements are on the field, the turn truly ends. If any weather/terrain was scheduled to end and did so, the new Pokémon come into the new conditions (no old weather if it ended).
- Battle End Check: After end-of-turn, check win/lose conditions. If one side has no remaining non-fainted Pokémon, the battle is over. If both sides run out due to a simultaneous KO (like Perish Song or explosion killing the last Pokémon on each side), it may be a draw or whatever the rules dictate. In a linked battle, typically if both last Pokémon faint, it’s a tie. In the engine, signal the battle outcome accordingly.

The turn is now complete, and the game would loop back to the move selection phase for the next turn, unless the battle ended. Make sure to reset any per-turn flags (e.g. a Pokémon’s “has moved this turn” status, flinch status wears off at turn’s end, etc.), and then allow players to choose actions for the new turn.

### Switching Priority vs Move Execution Recap

To specifically address switching and its priority relative to moves: switching (and item use) happens before normal moves during a turn . This means if you switch Pokémon A out and your opponent chose an attack with Pokémon B, Pokémon A will leave and Pokémon C (the replacement) comes in before Pokémon B’s attack goes off. Pokémon B’s attack then targets Pokémon C. The only scenario a move can happen before a switch is the Pursuit exception (Pursuit hits a fleeing Pokémon first) . So in summary, treat a manual switch as a priority action that resolves before any moves of priority 0 or lower. In code, you might handle this by splitting the action queue into “switches/items” vs “attacks” phases.

If both players switch, effectively both switches happen (the faster Pokémon’s switch resolves first, but it’s mostly inconsequential except for ability order). No moves are performed that turn; the turn then ends immediately after both switches (entry hazards and abilities still apply). This consumes the turn for both Pokémon.

Using Protect vs Switching: If one side uses Protect (priority +4) and the other switches (switch is effectively +6 priority or so), the switch will actually happen before the Protect (since switching is decided before moves). In practice though, that combination is rare, and it doesn’t conflict because Protect simply doesn’t have anything to block if the opponent switched (the next move coming might be from the new Pokémon next turn). It’s fine for Protect to go up even if no attack comes; it will just expire at turn’s end.

### 7. Stat Changes Persistence and Turn Order Effects

Finally, consider stat changes and how they persist across turns:

- Any stat modifications (raises or lowers) a Pokémon has will remain on that Pokémon as long as it stays in battle. These altered stats will affect move order and damage on subsequent turns. For example, if your Pokémon used Dragon Dance (+1 Attack, +1 Speed) last turn, those boosts are still in effect this turn (Speed is higher, likely moving first now, and Attack is higher for damage).
- Stat changes are reset to neutral (0 stage) when a Pokémon switches out . When it returns later, it won’t have those old boosts (unless it used Baton Pass to hand them off). The engine should clear a Pokémon’s stat stages upon switching out (except when Baton Pass is used, which intentionally carries over the stat stages to the switch-in).
- Speed changes in particular directly impact turn order. Abilities like Unburden (doubles Speed when the Pokémon consumes its item) persist as long as the Pokémon remains and had consumed an item. Paralysis speed reduction persists until cured. Tailwind’s Speed boost lasts for its duration across turns (it’s not a stat stage but a field effect doubling Speed).
- Slow Start (Regigigas ability) halves Attack and Speed for 5 turns from when it enters; after 5 turns, those stats go back to normal. This is essentially a turn-counted stat mod that the engine should track across turns.
- When calculating turn order each turn, use the stats as modified by any persisting effects. If Trick Room is active (lasts 5 turns), it will continue to invert the turn order each turn until it ends.
- Also note volatile status like confusion can last across turns (2-5 turns). If a Pokémon is confused at the end of a turn, it remains confused into the next turn (with counter decremented) and might hurt itself when it tries to move.

Everything above should be handled server-side in your Firebase function or Next.js API route to maintain authoritative game state. The server needs to compute all this logic to prevent cheating and ensure both clients see a consistent outcome. Each turn’s inputs (players’ actions) result in a sequence of state changes computed by these rules, and the resulting state is then sent to clients. Consider using a structured state object for Pokémon stats, conditions, field effects, etc., to systematically update each phase.

⸻

### Codex Prompt for Implementation

After understanding the detailed mechanics above, we can form a concise prompt for GitHub Copilot (OpenAI Codex) to help implement the battle logic. The prompt should focus on the functional requirements without UI, using the data structures that our Next.js/Firebase app might have (e.g. a JSON representation of the battle state). Below is an example of such a prompt:

Task: Implement a server-side function executeTurn(battleState) in TypeScript that simulates one turn of a Pokémon Generation 9 battle. The function should:

- Take the current battleState (including field conditions, each Pokémon’s stats, status, stat stages, current HP, etc., and the actions selected by each player for this turn).
- Process the turn in the correct order of phases: apply start-of-turn effects (hazards, weather activation messages, etc.), determine action order, and execute actions with all rules of priority and turn order (including abilities like Prankster, items like Quick Claw, and status like Trick Room affecting move order).
- Calculate damage for attacking moves with full Gen 9 formulas (type effectiveness, STAB, critical hits, weather boosts, stat modifications, reflect/light screen, etc.). Update HP and fainted status accordingly.
- Handle secondary move effects (status inflictions, stat changes) and ability triggers (e.g. Rough Skin, Static, Moxie) immediately after each move.
- Include logic for special cases:
- If a Pokémon uses Protect/Detect, ensure it blocks incoming move effects that turn (except where bypassed by certain moves/abilities). Manage the successive use fail chance.
- For multi-hit moves, loop through hits with separate damage calculations and stop early if the target faints.
- If a Pokémon flinches or is fully paralyzed, skip its move.
- If a Pokémon’s action is to switch out, perform the switch before other moves, and adjust turn order accordingly. Apply hazard damage and ability effects on the new Pokémon.
- Implement Pursuit hitting a switching Pokémon before it leaves.
- After executing all actions, apply end-of-turn effects: residual status damage (burn, poison), weather damage (sandstorm), healing from leftovers, leech seed drain, ability effects like Speed Boost, etc. Update the state for each.
- If any Pokémon fainted, mark them as fainted and remove them at end of turn. Queue up replacement logic (the battleState can include a queue for pending switch-ins if applicable).
- Finally, return the updated battleState reflecting all HP changes, status changes, fainted Pokémon, and any ongoing effect counters decrementing.

Make sure the function is pure logic (no UI or console output) – it should just update the battle state data. Use clear data structures for Pokémon stats and conditions. Include comments for each step (start of turn, action order, damage calculation, end of turn) for clarity. Ensure the implementation accounts for Gen 9 specifics (e.g., snow instead of hail, Terrastal phenomenon if included, etc.).
