{
  "rules": {
    ".read": false,
    ".write": false,

    "presence": {
      "$uid": {
        ".read": "auth != null && auth.uid == $uid",
        ".write": "auth != null && auth.uid == $uid"
      }
    },

    "lobbies": {
      "$region": {
        "queue": {
          "$uid": {
            ".read": "auth != null && auth.uid == $uid",
            ".write": "auth != null && auth.uid == $uid",
            "joinedAt": {".validate": "newData.isNumber() || newData.val() == now"}
          }
        }
      }
    },

    "battles": {
      "$bid": {
        "meta": {
          ".read": "auth != null && (root.child('battles/'+$bid+'/meta/players/p1/uid').val() == auth.uid || root.child('battles/'+$bid+'/meta/players/p2/uid').val() == auth.uid)",
          ".write": false
        },
        "public": {
          ".read": "auth != null && (root.child('battles/'+$bid+'/meta/players/p1/uid').val() == auth.uid || root.child('battles/'+$bid+'/meta/players/p2/uid').val() == auth.uid)",
          ".write": false
        },
        "private": {
          "$uid": {
            ".read": "auth != null && auth.uid == $uid",
            ".write": false
          },
          "$other": {
            ".read": false, 
            ".write": false
          }
        },
        "turns": {
          "$turn": {
            "choices": {
              "$uid": {
                ".read": "auth != null && auth.uid == $uid",
                ".write": "auth != null && auth.uid == $uid && root.child('battles/'+$bid+'/meta/phase').val() == 'choosing' && !data.exists() && newData.child('action').isString() && (newData.child('action').val() == 'move' || newData.child('action').val() == 'switch' || newData.child('action').val() == 'forfeit') && newData.child('clientVersion').val() == root.child('battles/'+$bid+'/meta/version').val()"
              }
            },
            "resolution": { 
              ".read": "auth != null && (root.child('battles/'+$bid+'/meta/players/p1/uid').val() == auth.uid || root.child('battles/'+$bid+'/meta/players/p2/uid').val() == auth.uid)", 
              ".write": false 
            }
          }
        }
      }
    }
  }
}
