<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Poké Replay Viewer</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background:#0b1220; color:#e5e7eb; }
  header { padding:16px 24px; background:#111827; position:sticky; top:0; box-shadow:0 2px 10px rgba(0,0,0,.4);}
  main { padding: 24px; max-width: 900px; margin: 0 auto; }
  .card { background:#111827; border:1px solid #1f2937; border-radius:14px; padding:16px; margin-bottom:16px; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .pill { background:#1f2937; border:1px solid #374151; padding:4px 10px; border-radius:999px; font-size:12px; }
  textarea { width:100%; height:160px; background:#0b1220; color:#e5e7eb; border:1px solid #374151; border-radius:8px; padding:8px; }
  button, input[type=file] { background:#2563eb; color:white; border:none; border-radius:10px; padding:8px 12px; cursor:pointer; }
  pre { white-space:pre-wrap; word-break:break-word; }
  .log { padding:6px 10px; border-bottom:1px solid #1f2937; }
  .muted { color:#9ca3af; }
</style>
</head>
<body>
<header>
  <div class="row">
    <strong>Poké Replay Viewer</strong>
    <input type="file" id="file" accept="application/json" />
    <button id="demo">Load Demo</button>
  </div>
</header>
<main>
  <div class="card">
    <p class="muted">Drop a JSON replay exported by <code>exportReplay</code>, or paste below:</p>
    <textarea id="paste" placeholder="Paste replay JSON here..."></textarea>
    <div class="row" style="margin-top:8px;">
      <button id="load">Load Replay</button>
      <span class="muted" id="err"></span>
    </div>
  </div>

  <div id="meta" class="card" style="display:none;"></div>
  <div id="turns"></div>
</main>
<script>
function render(replay) {
  const meta = document.getElementById('meta');
  meta.style.display = 'block';
  meta.innerHTML = `
    <div class="row">
      <span class="pill">Battle: ${replay.battleId || 'N/A'}</span>
      <span class="pill">Format: ${replay.meta?.format || 'singles'}</span>
      <span class="pill">Rule: ${replay.meta?.ruleSet || ''}</span>
      <span class="pill">Seed: ${replay.meta?.rng?.seed ?? '—'}</span>
    </div>
    <div style="margin-top:8px;" class="muted">
      P1: ${replay.meta?.players?.p1?.uid ?? '—'} &nbsp;&nbsp;|&nbsp;&nbsp;
      P2: ${replay.meta?.players?.p2?.uid ?? '—'}
    </div>
  `;
  const t = document.getElementById('turns');
  t.innerHTML = '';
  (replay.turns || []).sort((a,b)=>a.turn-b.turn).forEach(tr => {
    const card = document.createElement('div');
    card.className = 'card';
    const title = tr.replacements ? `Replacements (after Turn ${tr.turn})` : `Turn ${tr.turn}`;
    let html = `<strong>${title}</strong>`;
    if (tr.committedAt) {
      const dt = new Date(tr.committedAt);
      html += ` <span class="muted">— ${dt.toLocaleString()}</span>`;
    }
    html += `<div style="margin-top:8px;">${(tr.logs||[]).map(line => `<div class="log">${line}</div>`).join('')}</div>`;
    card.innerHTML = html;
    t.appendChild(card);
  });
}
function parseAndRender(text) {
  try {
    const obj = JSON.parse(text);
    render(obj);
    document.getElementById('err').textContent = '';
  } catch (e) {
    document.getElementById('err').textContent = 'Invalid JSON';
  }
}
document.getElementById('load').onclick = () => parseAndRender(document.getElementById('paste').value);
document.getElementById('demo').onclick = () => {
  const demo = {"version":1,"battleId":"demo","meta":{"format":"singles","ruleSet":"gen9-no-weather","players":{"p1":{"uid":"alice"},"p2":{"uid":"bob"}},"rng":{"seed":123,"cursor":5}},"initialPublic":{},"turns":[{"turn":1,"logs":["Battle started.","Alice used Thunderbolt!","Bob is paralyzed!"],"committedAt":Date.now()},{"turn":1,"replacements":true,"logs":["Alice sent out Garchomp!","Bob sent out Rotom-Wash!"],"committedAt":Date.now()}]};
  render(demo);
};
document.getElementById('file').onchange = async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const text = await f.text();
  parseAndRender(text);
};

async function loadFromQuery() {
  const url = new URL(location.href);
  const q = url.searchParams.get('replay');
  if (!q) return;
  try {
    // If it's a URL, fetch it; otherwise try base64 decode
    if (/^https?:\/\//i.test(q)) {
      const res = await fetch(q, { cache: "no-store" });
      const text = await res.text();
      parseAndRender(text);
    } else {
      const text = atob(q);
      parseAndRender(text);
    }
  } catch (e) {
    document.getElementById('err').textContent = 'Failed to load ?replay=';
  }
}
loadFromQuery();
</script>
</body>
</html>
